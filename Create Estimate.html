<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
      /* Simple loading spinner animation */
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-gray-50 p-4 font-sans text-gray-800">
    <div class="flex flex-col h-full">
      <h1 class="text-2xl font-bold mb-4 text-gray-800">Create Estimate</h1>
      
      <p class="text-sm text-gray-600 mb-4 p-3 bg-blue-100 rounded-lg">
        To appear in this list, a PO must meet the following criteria:
        <br>- 'BOL#' column must not be empty
        <br>- 'Estimate #' column must be empty
      </p>

      <div id="loading" class="text-center py-8">
        <div class="loading-spinner mx-auto mb-2"></div>
        <p>Loading PO Numbers...</p>
      </div>

      <div id="content" class="flex-grow overflow-y-auto hidden">
        
        <label for="po-select" class="block text-sm font-medium text-gray-700 mb-2">
          Select PO Number:
        </label>
        <select id="po-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">-- Select PO# --</option>
        </select>

        <div class="mt-4 flex justify-between items-center">
          <p id="no-orders" class="text-gray-500 hidden">No pending POs found.</p>
          <button id="refresh-button" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300">
            Refresh
          </button>
        </div>
      </div>

      <div id="status-message" class="mt-4 p-3 rounded-lg text-sm text-center hidden"></div>
      
      <div id="action-buttons" class="mt-auto pt-4 border-t-2 border-gray-200 flex justify-between space-x-2">
        <button id="cancel-button" class="flex-1 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
          Cancel
        </button>
        <button id="create-button" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
          Create
        </button>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const loadingDiv = document.getElementById('loading');
        const contentDiv = document.getElementById('content');
        const poSelect = document.getElementById('po-select');
        const noOrdersP = document.getElementById('no-orders');
        const refreshButton = document.getElementById('refresh-button');
        const createButton = document.getElementById('create-button');
        const cancelButton = document.getElementById('cancel-button');
        const statusMessageDiv = document.getElementById('status-message');

        function showMessage(message, type) {
          statusMessageDiv.textContent = message;
          statusMessageDiv.className = `mt-4 p-3 rounded-lg text-sm text-center ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
          statusMessageDiv.style.display = 'block';
        }

        function loadPendingOrders() {
          loadingDiv.style.display = 'block';
          contentDiv.style.display = 'none';
          noOrdersP.style.display = 'none'; // Hide by default
          poSelect.innerHTML = '<option value="">-- Select PO# --</option>';
          createButton.disabled = true;
          createButton.classList.add('bg-gray-400');
          createButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');

          google.script.run
            .withSuccessHandler(function(orders) {
              loadingDiv.style.display = 'none';
              contentDiv.style.display = 'block';
              
              if (orders.length > 0) {
                orders.forEach(function(order) {
                  const option = document.createElement('option');
                  option.value = order.po;
                  option.textContent = order.po;
                  poSelect.appendChild(option);
                });
                poSelect.disabled = false;
              } else {
                noOrdersP.style.display = 'block';
                poSelect.disabled = true;
              }
            })
            .withFailureHandler(function(error) {
              loadingDiv.style.display = 'none';
              contentDiv.style.display = 'block';
              noOrdersP.style.display = 'block';
              noOrdersP.textContent = `Loading error: ${error.message}`;
              poSelect.disabled = true;
              console.error('Failed to load pending orders:', error);
            })
            .getPendingOrders();
        }

        poSelect.addEventListener('change', function() {
          if (this.value) {
            createButton.disabled = false;
            createButton.classList.remove('bg-gray-400');
            createButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
          } else {
            createButton.disabled = true;
            createButton.classList.add('bg-gray-400');
            createButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          }
        });

        createButton.addEventListener('click', function() {
          const selectedPo = poSelect.value;
          if (!selectedPo) {
            showMessage('Please select a PO number.', 'error');
            return;
          }

          createButton.disabled = true;
          createButton.textContent = 'Creating...';
          cancelButton.disabled = true;
          
          google.script.run
            .withSuccessHandler(function(response) {
              if (response.startsWith('success')) {
                showMessage(`Successfully created estimate for PO #${selectedPo}!`, 'success');
              } else {
                showMessage(`Failed to create estimate: ${response}`, 'error');
              }
              createButton.disabled = false;
              createButton.textContent = 'Create';
              cancelButton.disabled = false;
              loadPendingOrders();
            })
            .withFailureHandler(function(error) {
              showMessage(`Creation failed: ${error.message}`, 'error');
              createButton.disabled = false;
              createButton.textContent = 'Create';
              cancelButton.disabled = false;
              console.error('Failed to create estimate:', error);
            })
            .createEstimate({ po: selectedPo });
        });

        cancelButton.addEventListener('click', function() {
          google.script.host.close();
        });

        refreshButton.addEventListener('click', function() {
          loadPendingOrders();
        });

        // Initial load
        loadPendingOrders();
      });
    </script>
  </body>
</html>