<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1rem; }
    .status-message { margin-top: 1rem; font-weight: bold; }
    #void-confirm-section { border-left: 5px solid #dc3545; }
    /* --- NEW ---: Style for the progress list header */
    #progress-header {
        font-weight: bold;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h4>PO Management Tool</h4>

    <ul class="nav nav-tabs" id="po-tool-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="new-tab" data-bs-toggle="tab" data-bs-target="#new-pane" type="button">New PO</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="update-tab" data-bs-toggle="tab" data-bs-target="#update-pane" type="button">Update PO</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="void-tab" data-bs-toggle="tab" data-bs-target="#void-pane" type="button">Void PO</button>
      </li>
    </ul>

    <div class="tab-content pt-3" id="po-tool-tab-content">
      <div class="tab-pane fade show active" id="new-pane" role="tabpanel">
        <form id="newPoForm">
          <div class="mb-3"><label for="pdfFileNew" class="form-label">Select PDF File</label><input type="file" id="pdfFileNew" class="form-control" accept=".pdf" required></div>
          <div class="mb-3"><label for="buyerName" class="form-label">Buyer Name</label><select id="buyerName" class="form-select" required><option value="" disabled selected>Loading...</option></select></div>
          <div class="mb-3"><label for="poNumberNew" class="form-label">PO Number</label><input type="text" id="poNumberNew" class="form-control" required></div>
          <button type="submit" id="newPoBtn" class="btn btn-primary w-100">Upload New PO</button>
        </form>
      </div>

      <div class="tab-pane fade" id="update-pane" role="tabpanel">
        <form id="updatePoForm">
          <div class="mb-3"><label for="pdfFileUpdate" class="form-label">Select Updated PDF</label><input type="file" id="pdfFileUpdate" class="form-control" accept=".pdf" required></div>
          <div class="mb-3"><label for="poNumberUpdate" class="form-label">Existing PO to Update</label><select id="poNumberUpdate" class="form-select" required><option value="" disabled selected>Loading...</option></select></div>
          <button type="submit" id="updatePoBtn" class="btn btn-warning w-100">Upload Update</button>
        </form>
      </div>

      <div class="tab-pane fade" id="void-pane" role="tabpanel">
        <div class="mb-3"><label for="poNumberVoid" class="form-label">Active PO to Void</label><select id="poNumberVoid" class="form-select"><option value="" disabled selected>Loading...</option></select></div>
        <div id="void-confirm-section" class="p-3 bg-danger-subtle d-none mt-4 rounded">
            <p class="fw-bold">Are you sure you want to void PO #<span id="confirm-po-number" class="text-danger"></span>?</p>
            <p class="small">This will mark all related rows in 'Dealer PO | Raw Data' as voided.</p>
            <button type="button" id="confirmVoidBtn" class="btn btn-danger w-100">Yes, Void This PO</button>
        </div>
      </div>
    </div>

    <div id="status" class="status-message"></div>
    
    <div id="progress-container" class="d-none">
        <h6 id="progress-header">Queued for Upload</h6>
        <ul id="upload-progress-list" class="list-group"></ul>
    </div>
    
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      showStatus('Loading initial data...', 'info');
      google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onFailure).getPoMgtInitialData();

      document.getElementById('newPoForm').addEventListener('submit', handleNewSubmit);
      document.getElementById('updatePoForm').addEventListener('submit', handleUpdateSubmit);
      document.getElementById('poNumberVoid').addEventListener('change', handleVoidSelection);
      document.getElementById('confirmVoidBtn').addEventListener('click', handleVoidSubmit);
    });

    function onDataLoaded(data) {
      populateDropdown('buyerName', data.buyerNames, '-- Select Buyer --');
      populateDropdown('poNumberUpdate', data.existingPoNumbers, '-- Select PO to Update --');
      populateDropdown('poNumberVoid', data.activePoNumbers, '-- Select PO to Void --');
      showStatus('Ready.', 'success');
    }

    function populateDropdown(elementId, items, placeholder) {
      const select = document.getElementById(elementId);
      select.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
      items.forEach(item => { select.add(new Option(item, item)); });
    }

    function handleNewSubmit(e) {
      e.preventDefault();
      const file = document.getElementById('pdfFileNew').files[0];
      const buyer = document.getElementById('buyerName').value;
      const poNum = document.getElementById('poNumberNew').value;
      if (!file || !buyer || !poNum) { 
        showStatus('Please complete all fields for the new PO.', 'danger'); 
        return; 
      }
      
      const btn = document.getElementById('newPoBtn');
      setButtonLoading(btn, true);
      
      const reader = new FileReader();
      reader.onload = (event) => {
        // --- MODIFIED: Use a specific success handler for queuing ---
        google.script.run
          .withSuccessHandler(onNewPoSuccess)
          .withFailureHandler(onFailure)
          .processNewPoUpload(event.target.result, buyer, poNum);
      };
      reader.readAsDataURL(file);
    }
    
    // --- NEW: Success handler specifically for queued New POs ---
    function onNewPoSuccess(response) {
        setButtonLoading(document.getElementById('newPoBtn'), false, 'Upload New PO');
        
        if (response && response.success) {
            document.getElementById('progress-container').classList.remove('d-none');
            const progressList = document.getElementById('upload-progress-list');
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-info';
            li.innerHTML = `âœ… <strong>${response.fileName}</strong> - Queued for upload.`;
            progressList.appendChild(li);

            // Reset only the new PO form for rapid entry
            document.getElementById('newPoForm').reset();
            document.getElementById('status').innerHTML = ''; // Clear any previous errors
        } else {
            onFailure({ message: "Failed to add to queue. Please try again." });
        }
    }

    function handleUpdateSubmit(e) {
      e.preventDefault();
      const file = document.getElementById('pdfFileUpdate').files[0];
      const poNum = document.getElementById('poNumberUpdate').value;
      if (!file || !poNum) { 
          showStatus('Please select a file and PO number to update.', 'danger'); 
          return; 
      }

      const btn = document.getElementById('updatePoBtn');
      setButtonLoading(btn, true);

      const reader = new FileReader();
      reader.onload = (event) => {
        google.script.run
          .withSuccessHandler(onSuccess) // Uses the original success handler
          .withFailureHandler(onFailure)
          .processPoUpdate(event.target.result, poNum);
      };
      reader.readAsDataURL(file);
    }
    
    function handleVoidSelection() {
        const poNumber = document.getElementById('poNumberVoid').value;
        const confirmSection = document.getElementById('void-confirm-section');
        if (poNumber) {
            document.getElementById('confirm-po-number').textContent = poNumber;
            confirmSection.classList.remove('d-none');
        } else {
            confirmSection.classList.add('d-none');
        }
    }

    function handleVoidSubmit() {
      const poNum = document.getElementById('poNumberVoid').value;
      const btn = document.getElementById('confirmVoidBtn');
      setButtonLoading(btn, true);
      google.script.run
        .withSuccessHandler(onSuccess) // Uses the original success handler
        .withFailureHandler(onFailure)
        .voidPo(poNum);
    }

    // This function now handles success for IMMEDIATE actions (Update, Void)
    function onSuccess(response) {
      const message = (typeof response === 'object' && response.message) ? response.message : response;
      showStatus(message, 'success');
      resetAllFormsAndReloadData();
    }

    function onFailure(error) {
      showStatus(`Error: ${error.message}`, 'danger');
      // On failure, it's safe to reset everything to give the user a clean slate
      resetAllFormsAndReloadData();
    }
    
    function resetAllFormsAndReloadData() {
        ['newPoForm', 'updatePoForm'].forEach(id => document.getElementById(id).reset());
        document.getElementById('void-confirm-section').classList.add('d-none');
        document.getElementById('poNumberVoid').value = '';
        setButtonLoading(document.getElementById('newPoBtn'), false, 'Upload New PO');
        setButtonLoading(document.getElementById('updatePoBtn'), false, 'Upload Update');
        setButtonLoading(document.getElementById('confirmVoidBtn'), false, 'Yes, Void This PO');
        
        showStatus('Reloading lists...', 'info');
        google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onFailure).getPoMgtInitialData();
    }

    function setButtonLoading(btn, isLoading, defaultText = '') {
        btn.disabled = isLoading;
        if (isLoading) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
        } else if (defaultText) {
            btn.innerHTML = defaultText;
        }
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.innerHTML = `<div class="alert alert-${type} mt-3">${message}</div>`;
    }
  </script>
</body>
</html>