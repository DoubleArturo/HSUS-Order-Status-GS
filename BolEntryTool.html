<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 1rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .form-label { font-weight: 500; }
    #status-message { margin-top: 1rem; }
    .bol-entry { 
      border: 1px solid #dee2e6; 
      border-radius: 0.375rem; 
      padding: 1rem; 
      margin-bottom: 1rem; 
      position: relative; 
      background-color: #f8f9fa;
    }
    .remove-bol-btn { 
      position: absolute; 
      top: 0.5rem; 
      right: 0.5rem; 
      padding: 0.25rem 0.5rem; 
    }
    .loader { 
      border: 4px solid #f3f3f3; 
      border-radius: 50%; 
      border-top: 4px solid #0d6efd; 
      width: 24px; 
      height: 24px; 
      animation: spin 1.5s linear infinite; 
      margin-top: 1rem; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    h4, h5 { color: #212529; }
    
    .ts-wrapper {
      width: 100%; 
    }
    .ts-control {
      padding: 0.375rem 0.75rem !important; 
      font-size: 1rem; 
      line-height: 1.5; 
      width: 100%; 
    }
    .ts-dropdown {
      width: 100%; 
    }
    .ts-control .ts-placeholder {
      color: #6c757d; 
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h4>BOL Entry Tool (Step 2)</h4>
    <p class="text-muted">Select an item to create or edit Bill of Lading (BOL) records.</p>

    <div class="mb-3">
      <label for="po-sku-select" class="form-label">Pending Items</label>
      <select id="po-sku-select"></select>
    </div>
    
    <hr class="my-4">

    <div id="fulfilled-section" class="mb-3">
        <label for="fulfilled-po-sku-select" class="form-label">Edit Fulfilled Items</label>
        <select id="fulfilled-po-sku-select"></select>
    </div>

    <div id="details-section" class="d-none">
      <hr class="my-4">
      <h5 id="editing-header">Editing: </h5>
      <form id="bol-form">
        <div class="mb-3">
            <label for="act-ship-date" class="form-label">Actual Ship Date</label>
            <input type="date" id="act-ship-date" class="form-control" required>
        </div>
        <div id="bol-entries-container"></div>
        <button type="button" id="add-bol-btn" class="btn btn-outline-secondary btn-sm mb-3">
          <i class="bi bi-plus-circle"></i> Add Another BOL
        </button>
        <div class="mb-3 text-end">
            <h5>Total Shipping Fee: $<span id="total-fee">0.00</span></h5>
        </div>
        <div class="form-check form-switch mb-4">
          <input class="form-check-input" type="checkbox" role="switch" id="fulfill-shipment-check">
          <label class="form-check-label" for="fulfill-shipment-check">Mark as Full Shipment</label>
        </div>
        <button type="submit" id="submit-btn" class="btn btn-primary w-100 mt-2">
          <i class="bi bi-check-circle-fill"></i> Save BOL Records
        </button>
      </form>
    </div>

    <div id="loader" class="loader d-none mx-auto"></div>
    <div id="status-message"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
  let currentSelection = null;
  let pendingSelect, fulfilledSelect;

  document.addEventListener("DOMContentLoaded", function() {
    showLoader(true);

    // --- üöÄ [UI ‰øÆÊ≠£] ---
    // Á´ãÂç≥ÂàùÂßãÂåñ Tom SelectÔºå‰∏¶È°ØÁ§∫ "Loading..."
    const commonSettings = {
      maxOptions: 200,
      allowEmptyOption: true,
      placeholder: "Loading...", // <-- ÊªøË∂≥ÊÇ®ÁöÑ "Loading" ÈúÄÊ±Ç
    };
    
    pendingSelect = new TomSelect('#po-sku-select', {
      ...commonSettings,
      onChange: value => {
        if (value) {
          loadItemForEditing(value);
          if (fulfilledSelect) fulfilledSelect.setValue('', true);
        }
      }
    });
    
    fulfilledSelect = new TomSelect('#fulfilled-po-sku-select', {
      ...commonSettings,
      onChange: value => {
        if (value) {
          loadItemForEditing(value);
          if (pendingSelect) pendingSelect.setValue('', true);
        }
      }
    });
    
    // Âú®ÂæåÁ´ØË≥áÊñôÂõû‰æÜÂâçÔºåÁ¶ÅÁî®‰∏ãÊãâÈÅ∏ÂñÆ
    pendingSelect.disable();
    fulfilledSelect.disable();
    // --- [UI ‰øÆÊ≠£ÁµêÊùü] ---

    google.script.run
        .withSuccessHandler(onInitialDataLoaded)
        .withFailureHandler(onFailure) // onFailure ÁèæÂú®‰πüÊúÉËôïÁêÜ UI
        .getInitialBolData();
    
    document.getElementById('bol-form').addEventListener('submit', handleFormSubmit);
    document.getElementById('add-bol-btn').addEventListener('click', () => addBolEntry());

    // (ÂÖ∂‰ªñ‰∫ã‰ª∂Áõ£ËÅΩÂô®‰øùÊåÅ‰∏çËÆä)
    const bolContainer = document.getElementById('bol-entries-container');
    bolContainer.addEventListener('input', (event) => {
      if (event.target.classList.contains('shipping-fee-input')) {
        updateTotalFee();
      }
    });
    bolContainer.addEventListener('click', (event) => {
      const removeButton = event.target.closest('.remove-bol-btn');
      if (removeButton) {
        if (bolContainer.children.length > 1) {
          removeButton.closest('.bol-entry').remove();
          updateTotalFee();
          renumberBolEntries();
        } else {
          showStatus("At least one BOL entry is required.", "warning");
        }
      }
    });
  });

  function onInitialDataLoaded(data) {
    showLoader(false);
    console.log('FRONTEND CHECKPOINT 1: onInitialDataLoaded triggered. Data received:', data);

    if (!data.success) {
      onFailure(data.message || 'Server returned an unsuccessful status.'); // ËΩâ‰∫§Áµ¶ onFailure ËôïÁêÜ
      return;
    }
    
    if (!Array.isArray(data.pendingList) || !Array.isArray(data.fulfilledList)) {
        onFailure('Error: Invalid data format received from server.');
        return;
    }

    console.log(`FRONTEND CHECKPOINT 2: Data structure confirmed. Pending: ${data.pendingList.length} items, Fulfilled: ${data.fulfilledList.length} items.`);

    // --- üöÄ [UI ‰øÆÊ≠£] ---
    // ‰∏çÂÜçÂª∫Á´ãÊñ∞ÁöÑ TomSelectÔºåËÄåÊòØËºâÂÖ•Ë≥áÊñôÂà∞Â∑≤Â≠òÂú®ÁöÑÂØ¶‰æã‰∏≠
    try {
        // ËºâÂÖ• Pending
        pendingSelect.clearOptions();
        pendingSelect.addOptions(data.pendingList.map(item => ({ value: item, text: item })));
        pendingSelect.setPlaceholder(data.pendingList.length > 0 ? "Search or select a pending item..." : "No pending items found");
        pendingSelect.enable();
        console.log('FRONTEND CHECKPOINT 3a: populatePendingDropdown finished.');

        // ËºâÂÖ• Fulfilled
        fulfilledSelect.clearOptions();
        fulfilledSelect.addOptions(data.fulfilledList.map(item => ({ value: item.key, text: item.key })));
        fulfilledSelect.setPlaceholder(data.fulfilledList.length > 0 ? "Search or select a fulfilled item..." : "No fulfilled items found");
        fulfilledSelect.enable();
        console.log('FRONTEND CHECKPOINT 3b: populateFulfilledDropdown finished.');
        
    } catch (e) {
        onFailure(e.message || 'Error during UI initialization.');
    }
    // --- [UI ‰øÆÊ≠£ÁµêÊùü] ---

    console.log('FRONTEND CHECKPOINT 4: onInitialDataLoaded completed successfully.');
  }

  // --- üöÄ [UI ‰øÆÊ≠£] ---
  // Âà™Èô§ËàäÁöÑ populatePendingDropdown Âíå populateFulfilledDropdown ÂáΩÊï∏
  // (ÂÆÉÂÄëÁöÑÂäüËÉΩÂ∑≤Âêà‰ΩµÂà∞ onInitialDataLoaded)
  
  function loadItemForEditing(poSkuKey) {
    if (!poSkuKey) {
      document.getElementById('details-section').classList.add('d-none');
      return;
    }
    currentSelection = poSkuKey;
    
    showLoader(true);
    document.getElementById('details-section').classList.add('d-none');
    google.script.run
      .withSuccessHandler(onExistingDataReceived)
      .withFailureHandler(onFailure)
      .getExistingBolData(poSkuKey);
  }

  function onExistingDataReceived(data) {
    showLoader(false);
    if (!data.success) {
      onFailure(data);
      return;
    }
    document.getElementById('editing-header').textContent = `Editing: ${currentSelection}`;
    document.getElementById('act-ship-date').value = data.actShipDate || new Date().toISOString().split('T')[0];
    document.getElementById('fulfill-shipment-check').checked = data.isFulfilled;
    
    const container = document.getElementById('bol-entries-container');
    container.innerHTML = '';

    if (data.bols && data.bols.length > 0) {
      data.bols.forEach(bol => addBolEntry(bol));
    } else {
      addBolEntry();
    }
    updateTotalFee();
    document.getElementById('details-section').classList.remove('d-none');
  }

  function addBolEntry(bol = {}) {
    const container = document.getElementById('bol-entries-container');
    const entryIndex = container.children.length;
    const entryDiv = document.createElement('div');
    entryDiv.className = 'bol-entry';
    const isSigned = bol.signed === true;
    entryDiv.innerHTML = `
      <button type="button" class="btn-close remove-bol-btn" aria-label="Close"></button>
      <div class="row g-3">
        <div class="col-md-12"><label class="form-label bol-label">BOL #${entryIndex + 1}</label><input type="text" class="form-control bol-number-input" placeholder="Enter BOL number" value="${bol.bolNumber || ''}" required></div>
        <div class="col-6"><label class="form-label">Shipped Qty</label><input type="number" class="form-control shipped-qty-input" min="1" value="${bol.shippedQty || ''}" required></div>
        <div class="col-6"><label class="form-label">Shipping Fee</label><input type="number" class="form-control shipping-fee-input" min="0" step="0.01" value="${bol.shippingFee || 0}"></div>
        <div class="col-12"><div class="form-check mt-2"><input class="form-check-input signed-bol-checkbox" type="checkbox" id="signed-bol-${entryIndex}" ${isSigned ? 'checked' : ''}><label class="form-check-label" for="signed-bol-${entryIndex}">Signed BOL Received?</label></div></div>
      </div>
    `;
    container.appendChild(entryDiv);
    renumberBolEntries();
  }
  
  function updateTotalFee() {
    const feeInputs = document.querySelectorAll('.shipping-fee-input');
    let total = 0;
    feeInputs.forEach(input => { total += parseFloat(input.value) || 0; });
    document.getElementById('total-fee').textContent = total.toFixed(2);
  }

  function renumberBolEntries() {
    const allEntries = document.querySelectorAll('.bol-label');
    allEntries.forEach((label, index) => { label.textContent = `BOL #${index + 1}`; });
  }

  function handleFormSubmit(event) {
    event.preventDefault();
    showLoader(true);
    showStatus('Saving...', 'info');
    document.getElementById('submit-btn').disabled = true;

    const bolEntries = document.querySelectorAll('.bol-entry');
    const bolsData = Array.from(bolEntries).map(entry => ({
      bolNumber: entry.querySelector('.bol-number-input').value,
      shippedQty: entry.querySelector('.shipped-qty-input').value,
      shippingFee: entry.querySelector('.shipping-fee-input').value,
      signed: entry.querySelector('.signed-bol-checkbox').checked,
    }));

    const formData = {
      poSkuKey: currentSelection,
      actShipDate: document.getElementById('act-ship-date').value,
      isFulfilled: document.getElementById('fulfill-shipment-check').checked,
      bols: bolsData
    };
    google.script.run.withSuccessHandler(onSaveSuccess).withFailureHandler(onFailure).saveBolData(formData);
  }

  function onSaveSuccess(response) {
    document.getElementById('submit-btn').disabled = false;
    showLoader(false);
    if (response.success) {
      showStatus(response.message, 'success');
      document.getElementById('details-section').classList.add('d-none');
      currentSelection = null;
      if (pendingSelect) pendingSelect.clear();
      if (fulfilledSelect) fulfilledSelect.clear();
      
      // ÈáçÊñ∞ËºâÂÖ•‰∏ãÊãâÈÅ∏ÂñÆ (ÊúÉÈ°ØÁ§∫ Loading...)
      pendingSelect.disable();
      fulfilledSelect.disable();
      pendingSelect.setPlaceholder("Loading...");
      fulfilledSelect.setPlaceholder("Loading...");
      google.script.run.withSuccessHandler(onInitialDataLoaded).withFailureHandler(onFailure).getInitialBolData();
    } else {
      showStatus(response.message, 'danger');
    }
  }

  // --- üöÄ [UI ‰øÆÊ≠£] ---
  // Êõ¥Êñ∞ onFailure ÂáΩÊï∏Ôºå‰ª•ËôïÁêÜ TomSelect ÁöÑÈåØË™§ÁãÄÊÖã
  function onFailure(error) {
    showLoader(false);
    document.getElementById('submit-btn').disabled = false;
    
    let errorMessage = 'An unexpected error occurred.';
    if (typeof error === 'object' && error !== null) {
        errorMessage = error.message || 'Server execution failed.';
    } else if (typeof error === 'string') {
        errorMessage = error;
    }

    // Âú® TomSelect ÊéßÂà∂È†Ö‰∏≠È°ØÁ§∫ÈåØË™§
    const errorPlaceholder = 'Error: ' + errorMessage;
    if (pendingSelect) {
        pendingSelect.clearOptions(); // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑËàäÈÅ∏È†Ö
        pendingSelect.setPlaceholder(errorPlaceholder);
        pendingSelect.enable(); // ÂÖÅË®±Áî®Êà∂ÈªûÊìäÔºåÂç≥‰ΩøÊòØÁ©∫ÁöÑ
    }
    if (fulfilledSelect) {
        fulfilledSelect.clearOptions();
        fulfilledSelect.setPlaceholder(errorPlaceholder);
        fulfilledSelect.enable();
    }
    
    showStatus('Error: ' + errorMessage, 'danger', 10000); // Âª∂Èï∑È°ØÁ§∫ÊôÇÈñì
    console.error(error);
  }
  
  function showStatus(message, type = 'info', duration = 5000) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.textContent = message;
    statusDiv.className = `alert alert-${type} mt-3`;
    if (type !== 'danger') {
      setTimeout(() => {
        if (statusDiv.textContent === message) {
          statusDiv.className = '';
          statusDiv.textContent = '';
        }
      }, duration);
    }
  }

  function showLoader(isLoading) {
    document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
  }
</script>
</body>
</html>
