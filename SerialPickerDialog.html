<!-- <!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 15px; 
        color: #333; 
        background-color: #f8f9fa; 
    }
    h3 { 
        color: #202124; 
        margin-top: 0; 
        margin-bottom: 20px; 
        font-size: 1.3em; 
        border-bottom: 2px solid #1a73e8; 
        padding-bottom: 5px;
    }
    .status-container { 
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
        max-height: calc(100vh - 80px); /* ç¢ºä¿å´é‚Šæ¬„ä¸æœƒè¶…å‡ºè¦–çª— */
        overflow-y: auto;
    }
    .list-section { 
        padding: 15px; 
        border: 1px solid #dadce0; 
        border-radius: 4px; 
        background-color: #fff; 
        flex-shrink: 0;
    }
    .list-section h4 { 
        color: #1a73e8; 
        margin-top: 0; 
        margin-bottom: 10px; 
        border-bottom: 1px solid #f0f0f0; 
        padding-bottom: 5px; 
        font-size: 1.1em;
    }
    .po-list { 
        max-height: 200px; 
        overflow-y: auto; 
        list-style: none; 
        padding: 0; 
        margin: 0; 
        border: 1px solid #eee; 
        border-radius: 4px;
    }
    .po-sku-item { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 8px 10px; 
        border-bottom: 1px dotted #e0e0e0; 
        transition: background-color 0.2s;
    }
    .po-sku-item:hover {
        background-color: #f6f6f6;
    }
    .po-sku-item:last-child { border-bottom: none; }
    .po-sku-info { 
        flex-grow: 1; 
        cursor: pointer; 
        padding-right: 10px;
    }
    .po-sku-key { 
        font-weight: bold; 
        font-size: 0.9em;
        display: block;
    }
    .po-sku-key .model-name {
        font-weight: normal;
        color: #70757a;
        font-size: 0.9em;
    }
    .complete-checkbox-container { 
        flex-shrink: 0; 
        display: flex;
        align-items: center;
    }
    .complete-checkbox-container label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .complete-checkbox-container input[type="checkbox"] { 
        transform: scale(1.2); 
        cursor: pointer; 
        margin: 0;
    }
    .loading-message { 
        text-align: center; 
        padding: 20px; 
        color: #70757a; 
    }
    .error-message { 
        color: #d93025; 
        text-align: center; 
        margin-top: 10px; 
        font-weight: bold;
    }
    .message-area { 
        margin-top: 10px; 
        font-weight: bold; 
        text-align: center; 
    }
    .success { color: #34a853; }
    .failure { color: #d93025; }
    .timestamp { font-size: 0.7em; color: #70757a; margin-left: 5px; }
  </style>
</head>
<body>
  <h3>ğŸ“¦ åºè™Ÿåˆ†é…ç®¡ç†å·¥å…·</h3>
  
  <div class="status-container">
    <div class="list-section">
      <h4>ğŸ“… å¾…è™•ç†æ¸…å–® (Pending)</h4>
      <div id="pendingList" class="po-list">
        <div class="loading-message">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    <div class="list-section">
      <h4>âœ… å·²å®Œæˆæ¸…å–® (Finished)</h4>
      <div id="finishedList" class="po-list">
        <div class="loading-message">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>
  
  <div class="error-message" id="errorMessage"></div>
  <div class="message-area" id="statusMessage"></div>
  
  <script>
    const pendingList = document.getElementById('pendingList');
    const finishedList = document.getElementById('finishedList');
    const statusMessage = document.getElementById('statusMessage');
    const errorMessage = document.getElementById('errorMessage');

    document.addEventListener('DOMContentLoaded', loadLists);

    /**
     * å¾ Apps Script è¼‰å…¥å¾…è™•ç†å’Œå·²å®Œæˆçš„ PO/SKU åˆ—è¡¨
     */
    function loadLists() {
      pendingList.innerHTML = '<div class="loading-message">è¼‰å…¥ä¸­...</div>';
      finishedList.innerHTML = '<div class="loading-message">è¼‰å…¥ä¸­...</div>';
      statusMessage.textContent = '';
      errorMessage.textContent = '';

      google.script.run
        .withSuccessHandler(renderLists)
        .withFailureHandler(function(error) {
          errorMessage.textContent = 'è¼‰å…¥åˆ—è¡¨å¤±æ•—: ' + error.message;
          pendingList.innerHTML = '<div class="loading-message">è¼‰å…¥éŒ¯èª¤</div>';
          finishedList.innerHTML = '<div class="loading-message">è¼‰å…¥éŒ¯èª¤</div>';
        })
        .getPoSkuLists();
    }

    /**
     * æ¸²æŸ“åˆ—è¡¨å…§å®¹
     * @param {Object} data - { pending: Array<Object>, finished: Array<Object> }
     */
    function renderLists(data) {
      renderList(pendingList, data.pending, false);
      renderList(finishedList, data.finished, true);
      
      if (data.pending.length === 0 && data.finished.length === 0) {
        statusMessage.className = 'message-area';
        statusMessage.textContent = 'è³‡æ–™åº«ä¸­æ²’æœ‰å¾…è™•ç†æˆ–å·²å®Œæˆçš„ PO/SKU é …ç›®ã€‚';
      }
    }

    /**
     * è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“å–®ä¸€åˆ—è¡¨
     */
    function renderList(container, items, isFinished) {
      container.innerHTML = '';
      if (items.length === 0) {
        container.innerHTML = `<div class="loading-message">${isFinished ? 'å°šç„¡å·²å®Œæˆé …ç›®' : 'å°šç„¡å¾…è™•ç†é …ç›®'}</div>`;
        return;
      }

      items.forEach(item => {
        const listItem = document.createElement('div');
        listItem.className = 'po-sku-item';
        
        // æå– Model Name
        const [poSkuKey, modelNameWithParens] = item.display.split(' ');
        const modelName = modelNameWithParens ? modelNameWithParens.replace(/[()]/g, '') : '';
        
        // é¡¯ç¤ºè³‡è¨Š (Display Name)
        const infoDiv = document.createElement('div');
        infoDiv.className = 'po-sku-info';
        infoDiv.innerHTML = `
            <span class="po-sku-key">${poSkuKey}</span>
            <span class="po-sku-key model-name">${modelName}</span>
        `;
        
        // å¦‚æœæ˜¯å·²å®Œæˆæ¸…å–®ï¼Œé¡¯ç¤ºæ™‚é–“æˆ³
        if (isFinished && item.timestamp && item.timestamp.getFullYear() > 1970) {
             const timeStr = item.timestamp.toLocaleDateString() + ' ' + item.timestamp.toLocaleTimeString();
             infoDiv.innerHTML += `<span class="timestamp"> | ${timeStr}</span>`;
        }
        
        // å‹¾é¸æ¡†
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'complete-checkbox-container';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = item.isComplete;
        checkbox.dataset.key = item.key; // å°‡åŸå§‹ key å„²å­˜åˆ° data å±¬æ€§

        checkboxDiv.appendChild(checkbox);
        listItem.appendChild(infoDiv);
        listItem.appendChild(checkboxDiv);
        container.appendChild(listItem);
        
        // è¨»å†Šäº‹ä»¶ç›£è½å™¨
        checkbox.addEventListener('change', handleCompletionChange);
        
        // é»æ“Šæ–‡å­—å€åŸŸæ™‚ï¼Œå¯ä»¥åˆ‡æ›åˆ° Serial Picker ä»‹é¢ (é€™è£¡åªåšè¨Šæ¯æç¤º)
        infoDiv.addEventListener('click', () => {
             statusMessage.className = 'message-area';
             statusMessage.textContent = `æ¬²ç·¨è¼¯ ${item.key} çš„åºè™Ÿï¼Œè«‹å‘¼å«å°æ‡‰çš„ Serial Picker ä»‹é¢ã€‚`;
        });
      });
    }

    /**
     * è™•ç†å‹¾é¸æ¡†è®Šæ›´äº‹ä»¶ (Mark as Complete / Re-open)
     */
    function handleCompletionChange(e) {
      const checkbox = e.target;
      const poSkuKey = checkbox.dataset.key;
      const isComplete = checkbox.checked;
      
      errorMessage.textContent = '';
      statusMessage.className = 'message-area';
      statusMessage.textContent = `è™•ç†ä¸­: ${poSkuKey} ...`;
      checkbox.disabled = true; // é–å®šæ“ä½œ

      google.script.run
        .withSuccessHandler(function(response) {
          checkbox.disabled = false;
          statusMessage.className = 'message-area success';
          statusMessage.textContent = response.message;
          // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥æ›´æ–°åˆ†çµ„ (å¾ Pending åˆ° Finished æˆ–ç›¸å)
          loadLists(); 
        })
        .withFailureHandler(function(error) {
          checkbox.checked = !isComplete; // æ¢å¾©ç‹€æ…‹
          checkbox.disabled = false;
          errorMessage.textContent = 'ç‹€æ…‹æ›´æ–°å¤±æ•—: ' + error.message;
          statusMessage.className = 'message-area failure';
          statusMessage.textContent = `æ›´æ–°å¤±æ•—: ${poSkuKey} ç‹€æ…‹å·²æ¢å¾©!`;
        })
        .updateAssignmentCompletionStatus(poSkuKey, isComplete);
    }
  </script>
</body>
</html> -->