<!DOCTYPE html>

<html>

<head>

<base target="_top">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>

body {

padding: 1rem;

font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

}

.form-label {

font-weight: 500;

}

.loader {

border: 4px solid #f3f3f3;

border-radius: 50%;

border-top: 4px solid #0d6efd;

width: 24px;

height: 24px;

animation: spin 1.5s linear infinite;

margin-top: 1rem;

}

@keyframes spin {

0% { transform: rotate(0deg); }

100% { transform: rotate(360deg); }

}

/* Custom Dropdown Styles */

.custom-dropdown-menu {

max-height: 300px;

overflow-y: auto;

width: 100%;

}

.custom-dropdown-menu .search-box-wrapper {

position: sticky;

top: 0;

background-color: white;

padding: 0.5rem;

z-index: 10;

}

.dropdown-item {

cursor: pointer;

}

.total-qty-badge {

font-size: 0.8em;

font-weight: normal;

color: #6c757d;

}

</style>

</head>

<body>

<div class="container-fluid">

<h4>Shipping Planning Tool</h4>

<p class="text-muted small">Select an item to plan, then allocate quantities and dates.</p>



<!-- Item Selection Dropdown -->

<div class="mb-3">

<label for="item-dropdown-btn" class="form-label">Item to Plan (PO | SKU)</label>

<div class="dropdown w-100">

<button class="btn btn-light border w-100 text-start d-flex justify-content-between align-items-center" type="button" id="item-dropdown-btn" data-bs-toggle="dropdown" aria-expanded="false">

<span>Loading...</span>

</button>

<div class="dropdown-menu custom-dropdown-menu" id="item-dropdown-menu">

<!-- Dropdown content will be generated by JavaScript -->

</div>

</div>

</div>



<!-- Planning Details Form -->

<div id="details-section" class="d-none mt-4">

<h5 id="editing-header" class="mb-3"></h5>

<form id="planning-form">

<div class="mb-3">

<label for="total-qty" class="form-label">Total Required Quantity</label>

<input type="number" id="total-qty" class="form-control" readonly disabled>

</div>

<div class="mb-3">

<label for="est-ship-date" class="form-label">Estimated Ship Date</label>

<input type="date" id="est-ship-date" class="form-control" required>

</div>

<div class="row g-3">

<div class="col">

<label for="qty-w" class="form-label">Ship from West</label>

<input type="number" id="qty-w" class="form-control qty-input" min="0" value="0" required>

</div>

<div class="col">

<label for="qty-e" class="form-label">Ship from East</label>

<input type="number" id="qty-e" class="form-control qty-input" min="0" value="0" required>

</div>

</div>

<div class="text-end text-muted small mt-2">

Allocated: <span id="allocated-qty">0</span>

</div>


<button type="submit" id="submit-btn" class="btn btn-primary w-100 mt-4">Save Plan</button>

</form>

</div>



<div id="loader" class="loader d-none mx-auto"></div>

<div id="status-message" class="mt-3"></div>



</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

let itemDetails = {};

let currentSelection = null;



document.addEventListener("DOMContentLoaded", function() {

showLoader(true);

google.script.run

.withSuccessHandler(onInitialDataLoaded)

.withFailureHandler(onFailure)

.getPlanningData();


document.getElementById('planning-form').addEventListener('submit', handleFormSubmit);

document.querySelectorAll('.qty-input').forEach(input => {

input.addEventListener('input', updateAllocatedQty);

});

});



function onInitialDataLoaded(data) {

showLoader(false);

if (!data.success) {

showStatus(data.message, 'danger');

return;

}

itemDetails = data.itemDetails;

populateItemDropdown(data.pendingList);

}



function populateItemDropdown(list) {

const btn = document.getElementById('item-dropdown-btn').querySelector('span');

const menu = document.getElementById('item-dropdown-menu');

btn.textContent = 'Select an item to plan...';

menu.innerHTML = '';



const searchWrapper = document.createElement('div');

searchWrapper.className = 'search-box-wrapper';

const searchInput = document.createElement('input');

searchInput.type = 'text';

searchInput.className = 'form-control';

searchInput.placeholder = 'Search PO or SKU...';

searchInput.addEventListener('keyup', () => filterCustomDropdown(searchInput, menu));

searchInput.addEventListener('click', (e) => e.stopPropagation());

searchWrapper.appendChild(searchInput);

menu.appendChild(searchWrapper);



if (list.length > 0) {

list.forEach(item => {

const a = document.createElement('a');

a.className = 'dropdown-item';

a.textContent = item;

a.addEventListener('click', () => handleDropdownSelect(item));

menu.appendChild(a);

});

} else {

const disabledItem = document.createElement('span');

disabledItem.className = 'dropdown-item text-muted';

disabledItem.textContent = 'No pending items';

menu.appendChild(disabledItem);

}

}



function filterCustomDropdown(input, menu) {

const filter = input.value.toUpperCase();

const items = menu.getElementsByTagName('a');

for (let i = 0; i < items.length; i++) {

const txtValue = items[i].textContent || items[i].innerText;

if (txtValue.toUpperCase().indexOf(filter) > -1) {

items[i].style.display = "";

} else {

items[i].style.display = "none";

}

}

}



function handleDropdownSelect(poSkuWithModel) {

// ⭐ 修正點 1: 解析出原始的 PO|SKU Key

// 假設格式是 "PO|SKU (Model Name)"，我們需要 "PO|SKU"

let poSkuKey = poSkuWithModel;

const match = poSkuWithModel.match(/^(.*?)\s+\(/);

if (match && match[1]) {

poSkuKey = match[1];

}


currentSelection = poSkuKey; // 儲存原始 Key (PO|SKU)

document.getElementById('item-dropdown-btn').querySelector('span').textContent = poSkuWithModel; // 顯示完整字串


// 透過原始 key 查找 itemDetails

const details = itemDetails[poSkuKey] || {};


// 顯示標題時使用原始 Key

document.getElementById('editing-header').textContent = `Planning for: ${poSkuKey}`;


document.getElementById('total-qty').value = details.totalQty || 0;

document.getElementById('est-ship-date').value = details.estShipDate || new Date().toISOString().split('T')[0];

document.getElementById('qty-e').value = details.qtyE || 0;

document.getElementById('qty-w').value = details.qtyW || 0;



updateAllocatedQty();

document.getElementById('details-section').classList.remove('d-none');

}



function updateAllocatedQty() {

const qtyE = parseInt(document.getElementById('qty-e').value, 10) || 0;

const qtyW = parseInt(document.getElementById('qty-w').value, 10) || 0;

document.getElementById('allocated-qty').textContent = qtyE + qtyW;

}



function handleFormSubmit(event) {

event.preventDefault();

showLoader(true);

showStatus('Saving...', 'info');

document.getElementById('submit-btn').disabled = true;



const totalQty = parseInt(document.getElementById('total-qty').value, 10);

const qtyE = parseInt(document.getElementById('qty-e').value, 10) || 0;

const qtyW = parseInt(document.getElementById('qty-w').value, 10) || 0;



if (qtyE + qtyW !== totalQty) {

onFailure({ message: `Quantity mismatch! Allocated (${qtyE + qtyW}) does not equal Total Required (${totalQty}).` });

return;

}



const formData = {

poSkuKey: currentSelection,

totalQty: totalQty,

estShipDate: document.getElementById('est-ship-date').value,

qtyE: qtyE,

qtyW: qtyW

};


google.script.run

.withSuccessHandler(onSaveSuccess)

.withFailureHandler(onFailure)

.savePlanningData(formData);

}



function onSaveSuccess(response) {

showLoader(false);

document.getElementById('submit-btn').disabled = false;

if (response.success) {

showStatus(response.message, 'success');

// Optionally refresh data after save

// google.script.run.withSuccessHandler(onInitialDataLoaded).withFailureHandler(onFailure).getPlanningData();

} else {

showStatus(response.message, 'danger');

}

}



function onFailure(error) {

showLoader(false);

document.getElementById('submit-btn').disabled = false;

showStatus('Error: ' + error.message, 'danger');

}


function showStatus(message, type = 'info') {

const statusDiv = document.getElementById('status-message');

statusDiv.textContent = message;

statusDiv.className = `alert alert-${type} mt-3`;

}



function showLoader(isLoading) {

document.getElementById('loader').style.display = isLoading ? 'block' : 'none';

}

</script>

</body>

</html>